<!-- Table Container -->
<div class="flex-1 min-w-0 bg-white dark:bg-neutral-800 rounded-lg shadow-2xl">
  <table #tableElement class="w-full table-fixed">
    <!-- Table Header -->
    <thead class="bg-gray-200 dark:bg-neutral-700 border-b dark:border-neutral-600 font-medium
                 text-gray-600 dark:text-gray-300 sticky top-0 z-10">
      <tr class="flex w-full items-center">
        <th class="w-12 shrink-0 px-4 py-3 flex items-center justify-center">
          <mat-checkbox
            [checked]="isAllSelected()"
            [indeterminate]="hasSelection() && !isAllSelected()"
            (change)="selectAllToggle.emit()"
          />
        </th>
        <th class="w-16 shrink-0 px-4 py-3 flex items-center font-medium">Type</th>
        <th class="flex-4 min-w-0 px-4 py-3 flex items-center font-medium cursor-pointer select-none hover:bg-gray-300 dark:hover:bg-neutral-600 transition-colors"
            (click)="sort.emit(0)">
          Name
          @if (sortCriteria().index === 0 && sortCriteria().order) {
            <mat-icon fontIcon="arrow_upward"></mat-icon>
          } @else if(sortCriteria().index === 0 && !sortCriteria().order) {
            <mat-icon fontIcon="arrow_downward"></mat-icon>
          }@else {
            <mat-icon fontIcon="unfold_more"></mat-icon>
          }
        </th>
        <th class="flex-2 min-w-0 px-4 py-3 flex items-center font-medium cursor-pointer select-none hover:bg-gray-300 dark:hover:bg-neutral-600 transition-colors"
            (click)="sort.emit(1)">
          Size
          @if (sortCriteria().index === 1 && sortCriteria().order) {
            <mat-icon fontIcon="arrow_upward"></mat-icon>
          } @else if(sortCriteria().index === 1 && !sortCriteria().order) {
            <mat-icon fontIcon="arrow_downward"></mat-icon>
          }@else {
            <mat-icon fontIcon="unfold_more"></mat-icon>
          }
        </th>
        <th class="flex-2 min-w-0 px-4 py-3 flex items-center font-medium cursor-pointer select-none hover:bg-gray-300 dark:hover:bg-neutral-600 transition-colors"
            (click)="sort.emit(2)">
          Last update
          @if (sortCriteria().index === 2 && sortCriteria().order) {
            <mat-icon fontIcon="arrow_upward"></mat-icon>
          } @else if(sortCriteria().index === 2 && !sortCriteria().order) {
            <mat-icon fontIcon="arrow_downward"></mat-icon>
          }@else {
            <mat-icon fontIcon="unfold_more"></mat-icon>
          }
        </th>
        <th
          class="flex-2 min-w-0 px-4 py-3 flex items-center font-medium"
        >
          Author
        </th>
        <th
          class="flex-3 min-w-0 px-4 py-3 flex items-center font-medium">
          Tags
        </th>
        <th class="flex items-center px-4 py-3">
          <mat-icon
            class="hover:bg-neutral-300 dark:hover:bg-neutral-600 cursor-pointer"
            fontIcon="refresh" [matTooltip]="'refresh'"
            (click)="refresh.emit()"></mat-icon>
        </th>
      </tr>
    </thead>

    <tbody class="dark:text-gray-200">
      <!-- Loading State -->
      @if (directoryContents().loading) {
        <tr class="flex w-full">
          <td class="flex-1 p-8 text-center">
            <mat-icon class="text-4xl text-gray-400 animate-spin" fontIcon="sync"></mat-icon>
            <p class="mt-2 text-gray-500 dark:text-gray-400">Loading...</p>
          </td>
        </tr>
      }

      <!-- Error State -->
      @else if (directoryContents().error) {
        <tr class="flex w-full">
          <td class="flex-1 p-8 text-center">
            <mat-icon class="text-4xl text-red-400" fontIcon="error_outlined"></mat-icon>
            <p class="mt-2 text-gray-500 dark:text-gray-400">Failed to load directory</p>
          </td>
        </tr>
      }

      <!-- Empty State -->
      @else if (!directoryContents().data || directoryContents().data!.length === 0) {
        <tr class="flex w-full">
          <td class="flex-1 p-8 text-center">
            <mat-icon class="text-4xl text-gray-400" fontIcon="folder_open"></mat-icon>
            <p class="mt-2 text-gray-500 dark:text-gray-400">No items in this directory</p>
          </td>
        </tr>
      }

      <!-- Content -->
      @else {
        @for (item of directoryContents().data; track item.node.id) {
          <mat-menu #operateMenu="matMenu">
            @if(item.node.isDir){
              <button mat-menu-item (click)="batchSyncDirectory.emit(item.node.name)">
                <mat-icon fontIcon="backup"></mat-icon>
                <span>Sync videos</span>
              </button>
              <button mat-menu-item (click)="refreshDirectoryMeta.emit(item)">
                <mat-icon fontIcon="refresh"></mat-icon>
                <span>Refresh Metadata</span>
              </button>
            }@else{
              <button mat-menu-item>
                <a
                  [routerLink]="videoPage(item.node)"
                  target="_blank"
                  class="flex items-center"
                >
                  <mat-icon fontIcon="play_circle"></mat-icon>
                  <span>Play Video</span>
                </a>
              </button>
              <button mat-menu-item (click)="editVideo.emit(item.node)">
                <mat-icon fontIcon="edit"></mat-icon>
                <span>Edit</span>
              </button>
              <button mat-menu-item (click)="deleteVideo.emit(item.node)" class="text-red-600">
                <mat-icon fontIcon="delete"></mat-icon>
                <span>Delete</span>
              </button>
            }
          </mat-menu>
          <tr
            class="flex w-full border-b dark:border-neutral-700 hover:bg-gray-50 dark:hover:bg-neutral-700"
            [class.bg-blue-50]="isSelected(item.node.id)"
            [class.dark:bg-neutral-600]="isSelected(item.node.id)"
            [class.cursor-pointer]="item.node.isDir"
            [matContextMenuTriggerFor]="operateMenu"
            (click)="nodeClick.emit(item)"
          >
            <!-- Checkbox -->
            <td class="w-12 shrink-0 px-4 py-3 flex items-center justify-center">
              @if (item.node.isDir) {
                <mat-checkbox [disabled]="true"/>
              } @else {
                <mat-checkbox
                  [checked]="isSelected(item.node.id)"
                  (change)="selectionToggle.emit(item.node.id)"
                  (click)="$event.stopPropagation()"
                />
              }
            </td>

            <!-- Type Icon -->
            <td class="w-16 shrink-0 px-4 py-3 flex items-center">
              @if (item.node.isDir) {
                <img src="foldericon.png" alt="folder" class="w-6 h-6" />
              } @else {
                <img src="videoicon.png" alt="video" class="w-6 h-6" />
              }
            </td>

            <!-- Name -->
            <td class="flex-4 min-w-0 px-4 py-3 flex items-center">
              @if (item.node.isDir) {
                <span
                  class="truncate text-blue-600 dark:text-blue-400 font-medium hover:underline hover:text-blue-700 dark:hover:text-blue-300"
                  [matTooltip]="item.node.name"
                  >
                  {{ item.node.name }}
                </span>
              } @else {
                <span class="truncate font-medium" [matTooltip]="item.node.name">{{ item.node.name }}</span>
              }
            </td>

            <!-- Size -->
            <td class="flex-2 min-w-0 px-4 py-3 flex items-center text-gray-600 dark:text-gray-400">
              @if(item.node.size > 0){
                <span class="truncate"
                  [matTooltip]="formatSize(item.node.size)">
                  {{ formatSize(item.node.size) }}
                </span>
              }
              @else{
                <span class="text-gray-400 dark:text-gray-500">-</span>
              }
            </td>

            <!-- Last Update -->
            <td class="flex-2 min-w-0 px-4 py-3 flex items-center text-gray-600 dark:text-gray-400">
              @if(item.node.lastModifyTime > 0){
                <span class="truncate"
                  [matTooltip]="formatDate(item.node.lastModifyTime)">
                  {{ formatDate(item.node.lastModifyTime) }}
                </span>
              }
              @else{
                <span class="text-gray-400 dark:text-gray-500">-</span>
              }
            </td>

            <!-- Author -->
            <td class="flex-2 min-w-0 px-4 py-3 flex items-center">
              @if(!item.node.isDir && item.node.author){
                <span
                  class="truncate bg-neutral-200 dark:bg-neutral-600 rounded-lg px-2"
                  [matTooltip]="item.node.author">
                  {{ item.node.author }}
                </span>
              } @else {
                <span class="text-gray-400 dark:text-gray-500">-</span>
              }
            </td>

            <!-- Tags -->
            <td class="flex-3 min-w-0 px-4 py-3 flex items-center">
              <div class="flex gap-1 flex-wrap overflow-hidden">
                @if (!item.node.isDir) {
                  @for (tag of getVisibleTags(item.node); track tag) {
                    <span
                      class="px-2 py-0.5 truncate bg-purple-100 dark:bg-purple-500/20 text-purple-700 dark:text-purple-300 rounded text-sm whitespace-nowrap">
                      {{ tag }}
                    </span>
                  }
                  @if (getRemainingTagsCount(item.node) > 0) {
                    <span
                      class="px-2 py-0.5 bg-gray-200 dark:bg-neutral-600 text-gray-600 dark:text-gray-300 rounded text-sm cursor-help whitespace-nowrap"
                      [matTooltip]="getAllRemainingTags(item.node)"
                    >
                      +{{ getRemainingTagsCount(item.node) }}
                    </span>
                  }
                  @if (item.node.tags.length === 0) {
                    <span class="text-gray-400 dark:text-gray-500">-</span>
                  }
                } @else {
                  <span class="text-gray-400 dark:text-gray-500">-</span>
                }
              </div>
            </td>

            <!-- Operations -->
            <td class="w-14 shrink-0 px-4 py-3 flex items-center justify-center">
              <button
                mat-icon-button
                [matMenuTriggerFor]="operateMenu"
                (click)="$event.stopPropagation()"
              >
                <mat-icon fontIcon="more_vert"></mat-icon>
              </button>
            </td>
          </tr>
        }
      }
    </tbody>
  </table>
</div>
