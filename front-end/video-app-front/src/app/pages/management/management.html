<div #managementContainer class="p-6 ml-4">
  <!-- Header -->
  <div class="flex items-center justify-between mb-6 mr-16">
    <div class="flex items-center gap-4">
      <span class="bg-gray-800 dark:bg-neutral-700 text-white px-4 py-2 rounded-lg font-medium">Current path:</span>
      <span class="text-gray-700 dark:text-gray-300 font-mono">{{ currentPathDisplay() }}</span>
    </div>
    <div class="flex gap-2">
      <button
        [disabled]="isAtRoot()"
        (click)="navigateBack()"
        class="px-4 py-2 bg-gray-700 hover:bg-gray-600 dark:bg-neutral-600 dark:hover:bg-neutral-500 disabled:bg-gray-400 disabled:cursor-not-allowed text-white rounded-lg font-medium transition-colors"
      >
        Return
      </button>
    </div>
  </div>

  <p class="mb-4 text-gray-600 dark:text-gray-400 italic">Right-click on an video item for more operations of videos.</p>

  <!-- Table with Back to Top Button -->
  <div class="flex gap-4 items-end">
    <!-- Table Container -->
    <div class="flex-1 min-w-0 bg-white dark:bg-neutral-800 rounded-lg shadow-2xl">
      <table class="w-full table-fixed">
        <!-- Table Header -->
        <thead class="bg-gray-200 dark:bg-neutral-700 border-b dark:border-neutral-600 font-medium text-gray-600 dark:text-gray-300 sticky top-0 z-10">
          <tr>
            <th class="w-[5%] px-4 py-3 text-left font-medium">
              <mat-checkbox
                [checked]="isAllSelected()"
                [indeterminate]="hasSelection() && !isAllSelected()"
                (change)="toggleSelectAll()"
              />
            </th>
            <th class="w-[8%] px-4 py-3 text-left font-medium">Type</th>
            <th class="w-[35%] px-4 py-3 text-left font-medium cursor-pointer select-none hover:bg-gray-200 dark:hover:bg-neutral-600 transition-colors"
                (click)="sortItemsBy(0)">
              <span class="flex items-center">
                Name
                @if (sortCriteria()[0]) {
                  <mat-icon class="ml-1 text-sm!" fontIcon="arrow_upward"></mat-icon>
                } @else {
                  <mat-icon class="ml-1 text-sm!" fontIcon="arrow_downward"></mat-icon>
                }
              </span>
            </th>
            <th class="w-[12%] px-4 py-3 text-left font-medium cursor-pointer select-none hover:bg-gray-200 dark:hover:bg-neutral-600 transition-colors"
                (click)="sortItemsBy(1)">
              <span class="flex items-center">
                Size
                @if (!sortCriteria()[1]) {
                  <mat-icon class="ml-1 text-sm!" fontIcon="arrow_upward"></mat-icon>
                } @else {
                  <mat-icon class="ml-1 text-sm!" fontIcon="arrow_downward"></mat-icon>
                }
              </span>
            </th>
            <th class="w-[12%] px-4 py-3 text-left font-medium cursor-pointer select-none hover:bg-gray-200 dark:hover:bg-neutral-600 transition-colors"
                (click)="sortItemsBy(2)">
              <span class="flex items-center">
                Last update
                @if (!sortCriteria()[2]) {
                  <mat-icon class="ml-1 text-sm!" fontIcon="arrow_upward"></mat-icon>
                } @else {
                  <mat-icon class="ml-1 text-sm!" fontIcon="arrow_downward"></mat-icon>
                }
              </span>
            </th>
            <th class="w-[25%] px-4 py-3 text-left font-medium">Tags</th>
            <th class="w-[8%] px-4 py-3 text-left font-medium"></th>
          </tr>
        </thead>

        <tbody class="dark:text-gray-200">
          <!-- Loading State -->
          @if (directoryContents().loading) {
            <tr>
              <td colspan="7" class="p-8 text-center">
                <mat-icon class="text-4xl text-gray-400 animate-spin" fontIcon="sync"></mat-icon>
                <p class="mt-2 text-gray-500 dark:text-gray-400">Loading...</p>
              </td>
            </tr>
          }

          <!-- Error State -->
          @else if (directoryContents().error) {
            <tr>
              <td colspan="7" class="p-8 text-center">
                <mat-icon class="text-4xl text-red-400" fontIcon="error_outlined"></mat-icon>
                <p class="mt-2 text-gray-500 dark:text-gray-400">Failed to load directory</p>
              </td>
            </tr>
          }

          <!-- Empty State -->
          @else if (!directoryContents().data || directoryContents().data!.length === 0) {
            <tr>
              <td colspan="7" class="p-8 text-center">
                <mat-icon class="text-4xl text-gray-400" fontIcon="folder_open"></mat-icon>
                <p class="mt-2 text-gray-500 dark:text-gray-400">No items in this directory</p>
              </td>
            </tr>
          }

          <!-- Content -->
          @else {
            @for (item of directoryContents().data; track item.node.id) {
              <mat-menu #operateMenu="matMenu">
                @if(item.node.isDir){
                  <button mat-menu-item (click)="openBatchOperationPanel('directory', item.node.name)">
                    <mat-icon fontIcon="backup"></mat-icon>
                    <span>Sync videos</span>
                  </button>
                  <button mat-menu-item (click)="refreshSelectedDirectory(item)">
                    <mat-icon fontIcon="refresh"></mat-icon>
                    <span>Refresh Metadata</span>
                  </button>
                }@else{
                  <button mat-menu-item>
                    <a
                      [routerLink]="videoPage(item.node)"
                      target="_blank"
                      class="flex items-center"
                    >
                      <mat-icon fontIcon="play_circle"></mat-icon>
                      <span>Play Video</span>
                    </a>
                  </button>
                  <button mat-menu-item (click)="openEditPanel(item.node)">
                    <mat-icon fontIcon="edit"></mat-icon>
                    <span>Edit</span>
                  </button>
                  <button mat-menu-item (click)="deleteVideo(item.node)" class="text-red-600">
                    <mat-icon fontIcon="delete"></mat-icon>
                    <span>Delete</span>
                  </button>
                }
              </mat-menu>
              <tr
                class="border-b dark:border-neutral-700 hover:bg-gray-50 dark:hover:bg-neutral-700"
                [class.bg-blue-50]="isSelected(item.node.id)"
                [class.dark:bg-neutral-600/30]="isSelected(item.node.id)"
                [class.cursor-pointer]="item.node.isDir"
                [matContextMenuTriggerFor]="operateMenu"
                (click)="onClickFileBrowseNode(item)"
              >
                <!-- Checkbox -->
                <td class="px-4 py-3">
                  @if (item.node.isDir) {
                    <mat-checkbox [disabled]="true"/>
                  } @else {
                    <mat-checkbox
                      [checked]="isSelected(item.node.id)"
                      (change)="toggleSelection(item.node.id)"
                      (click)="$event.stopPropagation()"
                    />
                  }
                </td>

                <!-- Type Icon -->
                <td class="px-4 py-3">
                  @if (item.node.isDir) {
                    <img src="foldericon.png" alt="folder" class="w-8 h-8" />
                  } @else {
                    <img src="videoicon.png" alt="video" class="w-8 h-8" />
                  }
                </td>

                <!-- Name -->
                <td class="px-4 py-3 truncate">
                  @if (item.node.isDir) {
                    <span class="text-blue-600 dark:text-blue-400 font-medium hover:underline hover:text-blue-700 dark:hover:text-blue-300">
                      {{ item.node.name }}
                    </span>
                  } @else {
                    <span class="font-medium">{{ item.node.name }}</span>
                  }
                </td>

                <!-- Size -->
                <td class="px-4 py-3 text-gray-600 dark:text-gray-400 truncate">
                  @if(item.node.size > 0){
                    {{ formatSize(item.node.size) }}
                  }
                  @else{
                    <span class="text-gray-400 dark:text-gray-500">-</span>
                  }
                </td>

                <!-- Last Update -->
                <td class="px-4 py-3 text-gray-600 dark:text-gray-400 truncate">
                  @if(item.node.lastModifyTime > 0){
                    {{ formatDate(item.node.lastModifyTime) }}
                  }
                  @else{
                    <span class="text-gray-400 dark:text-gray-500">-</span>
                  }
                </td>

                <!-- Tags -->
                <td class="px-4 py-3">
                  <div class="flex items-center gap-1 flex-wrap overflow-hidden">
                    @if (!item.node.isDir) {
                      @for (tag of getVisibleTags(item.node); track tag) {
                        <span class="px-2 py-0.5 bg-purple-100 dark:bg-purple-500/20 text-purple-700 dark:text-purple-300 rounded text-sm">
                          {{ tag }}
                        </span>
                      }
                      @if (getRemainingTagsCount(item.node) > 0) {
                        <span
                          class="px-2 py-0.5 bg-gray-200 dark:bg-neutral-600 text-gray-600 dark:text-gray-300 rounded text-sm cursor-help"
                          [matTooltip]="getAllRemainingTags(item.node)"
                        >
                          +{{ getRemainingTagsCount(item.node) }}
                        </span>
                      }
                      @if (item.node.tags.length === 0) {
                        <span class="text-gray-400 dark:text-gray-500">-</span>
                      }
                    } @else {
                      <span class="text-gray-400 dark:text-gray-500">-</span>
                    }
                  </div>
                </td>

                <!-- Operations Placeholder -->
                <td class="px-4 py-3">
                  <button
                    mat-icon-button
                    [matMenuTriggerFor]="operateMenu"
                    (click)="$event.stopPropagation()"
                  >
                    <mat-icon fontIcon="more_vert"></mat-icon>
                  </button>
                </td>
              </tr>
            }
          }
        </tbody>
      </table>
    </div>
    <!-- placeholder for back to top button-->
    <div class="w-16"></div>
  </div>
  <!-- Buttons group -->
  <div class="fixed bottom-1 right-6 self-end pb-2">
    <button
      (click)="openBatchOperationPanel('videos')"
      [disabled]="!hasSelection()"
      class="flex flex-col items-center w-full gap-1 px-4 py-3 mb-2 bg-cyan-500 hover:cursor-pointer hover:bg-cyan-600 disabled:bg-gray-400 disabled:cursor-not-allowed text-white rounded-lg font-medium transition-colors"
    >
      <span class="text-lg">({{ selectedCount() }})</span>
      <span class="text-xs">Batch</span>
    </button>
    <button
      (click)="refreshDirectory()"
      class="flex flex-col items-center w-full gap-1 px-4 py-3 mb-2 bg-gray-200 dark:bg-neutral-700 hover:cursor-pointer hover:bg-gray-300 dark:hover:bg-neutral-600 text-gray-800 dark:text-gray-200 rounded-lg font-medium transition-colors"
    >
      <mat-icon fontIcon="refresh"></mat-icon>
      <span class="text-xs">Refresh</span>
    </button>
    <button
      (click)="scrollTo(0)"
      class="flex flex-col items-center w-full gap-1 px-4 py-3 bg-gray-600 dark:bg-neutral-700 hover:cursor-pointer hover:bg-gray-500 dark:hover:bg-neutral-600 text-white rounded-lg font-medium transition-colors"
    >
      <mat-icon fontIcon="arrow_upward"></mat-icon>
      <span class="text-xs">Top</span>
    </button>
  </div>
</div>